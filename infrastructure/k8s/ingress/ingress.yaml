# ============================================
# Kubernetes Ingress Configuration
# ============================================

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: helpinminutes-ingress
  namespace: helpinminutes
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header Strict-Transport-Security "max-age=63072000" always;
      add_header X-Frame-Options DENY always;
      add_header X-Content-Type-Options nosniff always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
spec:
  tls:
    - hosts:
        - api.helpinminutes.com
        - admin.helpinminutes.com
        - console.helpinminutes.com
        - s3.helpinminutes.com
        - monitoring.helpinminutes.com
      secretName: helpinminutes-tls
  rules:
    # API Gateway
    - host: api.helpinminutes.com
      http:
        paths:
          - path: /api/auth
            pathType: Prefix
            backend:
              service:
                name: identity-service
                port:
                  number: 8081
          - path: /api/users
            pathType: Prefix
            backend:
              service:
                name: identity-service
                port:
                  number: 8081
          - path: /api/helpers
            pathType: Prefix
            backend:
              service:
                name: identity-service
                port:
                  number: 8081
          - path: /api/tasks
            pathType: Prefix
            backend:
              service:
                name: task-service
                port:
                  number: 8082
          - path: /api/notifications
            pathType: Prefix
            backend:
              service:
                name: task-service
                port:
                  number: 8082
          - path: /api/matching
            pathType: Prefix
            backend:
              service:
                name: matching-service
                port:
                  number: 8083
          - path: /api/payments
            pathType: Prefix
            backend:
              service:
                name: payment-service
                port:
                  number: 8084
          - path: /api/webhooks
            pathType: Prefix
            backend:
              service:
                name: payment-service
                port:
                  number: 8084
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: realtime-service
                port:
                  number: 8085

    # Admin Portal
    - host: admin.helpinminutes.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: admin-portal
                port:
                  number: 3000

    # MinIO Console
    - host: console.helpinminutes.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: minio-console
                port:
                  number: 9001

    # MinIO API
    - host: s3.helpinminutes.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: minio
                port:
                  number: 9000

    # Monitoring
    - host: monitoring.helpinminutes.com
      http:
        paths:
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
          - path: /prometheus
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090
          - path: /alertmanager
            pathType: Prefix
            backend:
              service:
                name: alertmanager
                port:
                  number: 9093
          - path: /jaeger
            pathType: Prefix
            backend:
              service:
                name: jaeger-query
                port:
                  number: 16686
