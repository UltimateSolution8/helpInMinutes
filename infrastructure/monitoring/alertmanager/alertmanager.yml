# ============================================
# HelpInMinutes Alertmanager Configuration
# ============================================

global:
  resolve_timeout: 5m
  slack_api_url: ${SLACK_API_URL}

route:
  group_by: ['alertname', 'severity', 'team']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default-receiver'
  routes:
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 0s
      repeat_interval: 1h
    - match:
        severity: warning
      receiver: 'warning-receiver'
      repeat_interval: 4h
    - match:
        team: database
      receiver: 'database-receiver'
    - match:
        team: payments
      receiver: 'payments-receiver'
    - match:
        team: infra
      receiver: 'infra-receiver'

receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts-helpinminutes'
        send_resolved: true
        title: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'critical-receiver'
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        title: 'üö® CRITICAL: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          *Instance:* {{ .Labels.instance }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        pagerduty_configs:
          - service_key: ${PAGERDUTY_SERVICE_KEY}
            severity: critical

  - name: 'warning-receiver'
    slack_configs:
      - channel: '#alerts-warning'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'database-receiver'
    slack_configs:
      - channel: '#alerts-database'
        send_resolved: true
        text: |
          {{ range .Alerts }}
          *Database Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'payments-receiver'
    slack_configs:
      - channel: '#alerts-payments'
        send_resolved: true
        text: |
          {{ range .Alerts }}
          *Payment Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
    pagerduty_configs:
      - service_key: ${PAGERDUTY_SERVICE_KEY}
        severity: error

  - name: 'infra-receiver'
    slack_configs:
      - channel: '#alerts-infra'
        send_resolved: true
        text: |
          {{ range .Alerts }}
          *Infrastructure Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}

inhibit_rules:
  # Inhibit alerts when the same alert is already firing at higher severity
  - source_match:
      severity: 'critical'
    target_match_re:
      severity: 'warning|info'
    equal: ['alertname', 'instance', 'service']

  # Inhibit infrastructure alerts when host is down
  - source_match:
      alertname: 'HostDown'
    target_match_re:
      alertname: 'HighCPUUsage|HighMemoryUsage|DiskSpaceLow'
    equal: ['instance']
